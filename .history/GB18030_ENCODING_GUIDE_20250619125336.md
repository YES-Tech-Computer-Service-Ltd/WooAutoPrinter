# GB18030编码支持指南

## 概述

本项目已添加对GB18030编码的完整支持，确保中文字符能够正确打印到热敏打印机上。

## 功能特性

### 1. 自动编码转换
- **优先使用GB18030编码**：支持最完整的中文字符集
- **自动回退机制**：如果GB18030不可用，自动回退到GBK编码
- **最终回退**：如果GBK也不可用，使用UTF-8编码

### 2. 支持的中文字符范围
- 基本汉字：0x4E00-0x9FFF
- 扩展A区：0x3400-0x4DBF
- 扩展B区：0x20000-0x2A6DF
- 扩展C区：0x2A700-0x2B73F
- 扩展D区：0x2B740-0x2B81F
- 扩展E区：0x2B820-0x2CEAF
- 兼容汉字：0xF900-0xFAFF
- 兼容扩展：0x2F800-0x2FA1F

## 使用方法

### 1. 自动使用
GB18030编码支持已集成到现有的打印流程中，无需额外配置：

```kotlin
// 正常打印订单，会自动使用GB18030编码
val success = printerManager.printOrder(order, config)
```

### 2. 测试GB18030编码
使用专门的测试方法验证编码功能：

```kotlin
// 测试GB18030编码功能
val success = printerManager.testGB18030Encoding(config)
```

### 3. 手动编码转换
如果需要手动转换文本编码：

```kotlin
// 在BluetoothPrinterManager中
val encodedBytes = convertTextToGB18030("你好世界")
```

## 技术实现

### 核心方法

#### `convertTextToGB18030(text: String): ByteArray`
- 优先尝试GB18030编码
- 失败时回退到GBK编码
- 最后回退到UTF-8编码

#### `containsChineseCharacters(text: String): Boolean`
- 检测文本是否包含中文字符
- 支持所有中文字符范围

#### `testGB18030Encoding(config: PrinterConfig): Boolean`
- 专门用于测试GB18030编码功能
- 打印包含中文字符的测试内容

### 修改的文件

1. **BluetoothPrinterManager.kt**
   - 修改`processFormattedLine`方法使用GB18030编码
   - 添加`convertTextToGB18030`方法
   - 添加`containsChineseCharacters`方法
   - 添加`testGB18030Encoding`测试方法
   - 更新所有使用charset的地方

2. **ChineseEncodingTest.kt**
   - 添加GB18030编码测试功能
   - 更新测试用例

## 测试方法

### 1. 运行编码测试
```kotlin
// 在应用启动时或需要时运行
ChineseEncodingTest.runAllTests()
```

### 2. 测试打印机编码
```kotlin
// 测试特定打印机的GB18030编码支持
val success = printerManager.testGB18030Encoding(printerConfig)
```

### 3. 查看日志
在Logcat中搜索以下标签查看详细日志：
- `BluetoothPrinterManager`
- `ChineseEncodingTest`

## 兼容性

### 支持的Android版本
- Android 4.0 (API 14) 及以上
- 需要系统支持GB18030字符集

### 支持的打印机
- 支持GB18030编码的热敏打印机
- 支持GBK编码的热敏打印机
- 支持UTF-8编码的热敏打印机

## 故障排除

### 1. 中文显示乱码
- 检查打印机是否支持GB18030/GBK编码
- 查看日志中的编码转换信息
- 尝试使用`testGB18030Encoding`方法测试

### 2. 编码转换失败
- 检查Android系统是否支持GB18030字符集
- 查看日志中的错误信息
- 系统会自动回退到其他编码方式

### 3. 打印内容为空
- 检查文本内容是否为空
- 查看编码转换是否成功
- 检查打印机连接状态

## 示例输出

### 测试打印内容示例
```
        GB18030编码测试
        ==================
中文测试文本：
你好世界
测试打印功能
中英文混合：Hello 世界
特殊字符：！@#￥%……&*（）
数字：1234567890
==================
如果以上中文正常显示
说明GB18030编码工作正常
==================
```

## 更新日志

### v1.0.0
- 添加GB18030编码支持
- 实现自动编码回退机制
- 添加编码测试功能
- 更新所有相关打印方法

## 注意事项

1. **性能考虑**：编码转换会增加少量CPU开销，但影响微乎其微
2. **内存使用**：GB18030编码可能比UTF-8占用更多字节
3. **兼容性**：确保打印机支持相应的编码格式
4. **测试建议**：在生产环境使用前，建议先进行编码测试

## 技术支持

如果遇到问题，请：
1. 查看应用日志中的详细错误信息
2. 运行`ChineseEncodingTest.runAllTests()`进行诊断
3. 使用`testGB18030Encoding`方法测试特定打印机
4. 检查打印机说明书中的编码支持情况 