# Android Crash Reporter 使用指南

这是一个完整的Android崩溃报告系统，与WordPress后端插件配合使用，提供全面的崩溃监控和报告功能。

## 功能特点

- 🔄 **自动崩溃捕获**：捕获未处理的异常和应用崩溃
- 📊 **详细设备信息**：收集设备型号、系统版本、内存状态等
- 📤 **智能上传**：失败重试、离线缓存、网络状态检测
- 🎯 **严重程度分级**：自动判断错误严重程度
- 🔧 **自定义数据**：支持添加业务相关的自定义信息
- 🛡️ **安全可靠**：API密钥认证、数据加密传输

## 快速开始

### 1. 配置WordPress后端

首先确保WordPress站点已安装并配置了crash reporter插件，获取：
- API端点URL
- API密钥

### 2. 在Application中初始化

```kotlin
class YourApplication : Application() {
    override fun onCreate() {
        super.onCreate()
        
        // 初始化崩溃报告系统（应该在所有其他初始化之前）
        CrashReporterManager.initialize(
            context = this,
            apiEndpoint = "https://yoursite.com/wp-json/android-crash/v2/report",
            apiKey = "your_api_key_here",
            enableDebugLogs = BuildConfig.DEBUG
        )
    }
}
```

### 3. 报告非致命异常

```kotlin
try {
    // 可能出错的代码
    riskyOperation()
} catch (e: Exception) {
    // 报告异常并继续执行
    CrashReporterManager.reportException(e, mapOf(
        "operation" to "data_sync",
        "user_id" to "12345"
    ))
}
```

## 详细使用方法

### 报告网络错误

```kotlin
CrashReporterUtils.reportNetworkError(
    url = "https://api.example.com/data",
    method = "GET",
    responseCode = 500,
    errorMessage = "服务器内部错误"
)
```

### 报告数据库错误

```kotlin
CrashReporterUtils.reportDatabaseError(
    query = "SELECT * FROM users WHERE id = ?",
    errorMessage = "数据库连接失败"
)
```

### 报告用户操作错误

```kotlin
CrashReporterUtils.reportUserActionError(
    action = "submit_order",
    screen = "CheckoutActivity",
    errorMessage = "订单提交失败"
)
)
```

### 报告性能问题

```kotlin
val startTime = System.currentTimeMillis()
performLongOperation()
val duration = System.currentTimeMillis() - startTime

CrashReporterUtils.reportPerformanceIssue(
    operation = "image_processing",
    duration = duration,
    threshold = 5000 // 5秒阈值
)
```

### 使用工具函数捕获异常

```kotlin
val result = CrashReporterUtils.catchAndReport(
    errorType = "DataProcessing",
    customData = mapOf("batch_size" to "100")
) {
    // 可能出错的代码
    processDataBatch()
}
```

## 错误类型分类

系统会自动根据异常类型判断严重程度：

### Critical（严重）
- `OutOfMemoryError`
- `SecurityException`
- 应用崩溃（fatal errors）

### High（高）
- `NullPointerException`
- `RuntimeException`
- `IllegalStateException`
- `ClassCastException`

### Medium（中等）
- `IOException`
- `SQLException`
- `ParseException`

### Low（低）
- 其他异常类型

## 最佳实践

### 1. 早期初始化
在Application.onCreate()的最开始初始化崩溃报告系统：

```kotlin
override fun onCreate() {
    super.onCreate()
    
    // 第一步：初始化崩溃报告
    initializeCrashReporter()
    
    // 然后进行其他初始化
    initializeOtherComponents()
}
```

### 2. 添加上下文信息
报告异常时提供有用的上下文信息：

```kotlin
CrashReporterManager.reportException(exception, mapOf(
    "user_id" to getCurrentUserId(),
    "screen" to getCurrentScreen(),
    "action" to "button_click",
    "app_state" to getAppState()
))
```

### 3. 网络状态考虑
系统会自动处理网络状态，但你可以手动控制：

```kotlin
// 在网络恢复时上传待处理的崩溃报告
if (NetworkChecker.isNetworkAvailable(context)) {
    CrashReporterManager.uploadPendingCrashes()
}
```

### 4. 定期清理
定期清理旧的崩溃文件：

```kotlin
// 在适当的时机（如应用启动时）清理
CrashReporterManager.cleanupOldCrashes()
```

## 常见错误码及触发条件

### HTTP状态码

| 状态码 | 含义 | 触发条件 | 处理方式 |
|--------|------|----------|----------|
| 200/201 | 成功 | 报告正常上传 | 删除本地文件 |
| 400 | 请求错误 | 缺少必需参数、JSON格式错误 | 不重试，记录错误 |
| 401 | 认证失败 | API密钥无效或过期 | 不重试，检查配置 |
| 413 | 文件过大 | 上传文件超过10MB限制 | 不重试，压缩数据 |
| 429 | 频率限制 | 超过每5分钟20次请求限制 | 等待后重试 |
| 500-504 | 服务器错误 | WordPress服务器问题 | 重试上传 |
| 507 | 存储空间不足 | 服务器存储达到上限 | 等待后重试 |

### 应用内错误码

| 错误类型 | 触发条件 | 严重程度 |
|----------|----------|----------|
| `NetworkError` | 网络请求失败 | Medium |
| `DatabaseError` | 数据库操作失败 | High |
| `OutOfMemoryError` | 内存不足 | Critical |
| `NullPointerException` | 空指针异常 | High |
| `SecurityException` | 权限或安全问题 | Critical |
| `ValidationError` | 数据验证失败 | Low |
| `PerformanceIssue` | 操作耗时过长 | Medium |

## 故障排除

### 1. 报告上传失败
检查：
- API端点URL是否正确
- API密钥是否有效
- 网络连接是否正常
- WordPress插件是否正常工作

### 2. 异常未被捕获
确保：
- 在Application.onCreate()中正确初始化
- 异常发生在初始化之后
- 没有其他异常处理器干扰

### 3. 性能影响
- 崩溃报告在后台线程处理，不影响UI
- 本地文件自动清理，避免存储占用
- 网络上传使用重试机制，避免阻塞

## 配置选项

```kotlin
val config = CrashReporterConfig(
    apiEndpoint = "API端点",
    apiKey = "API密钥",
    enableAutoUpload = true,           // 自动上传
    enableDebugLogs = BuildConfig.DEBUG, // 调试日志
    maxRetries = 3,                    // 最大重试次数
    connectTimeoutMs = 30000,          // 连接超时
    readTimeoutMs = 30000              // 读取超时
)
```

## 注意事项

1. **隐私保护**：不要在崩溃报告中包含敏感信息（密码、令牌等）
2. **API密钥安全**：将API密钥存储在安全位置，不要硬编码
3. **文件清理**：定期清理旧的崩溃文件，避免占用过多存储空间
4. **网络流量**：在移动网络下考虑限制上传频率
5. **用户同意**：根据法律要求，可能需要用户同意收集崩溃数据 