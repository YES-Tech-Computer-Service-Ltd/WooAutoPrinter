package com.example.wooauto.serviceimport android.app.Notificationimport android.app.NotificationChannelimport android.app.NotificationManagerimport android.app.PendingIntentimport android.app.Serviceimport android.content.Contextimport android.content.Intentimport android.content.IntentFilterimport android.content.pm.ServiceInfoimport android.os.Buildimport android.os.IBinderimport android.util.Logimport androidx.core.app.NotificationCompatimport androidx.core.content.ContextCompatimport com.example.wooauto.MainActivityimport com.example.wooauto.Rimport com.example.wooauto.data.local.WooCommerceConfigimport com.example.wooauto.domain.repositories.DomainOrderRepositoryimport com.example.wooauto.domain.models.Orderimport com.example.wooauto.domain.repositories.DomainSettingRepositoryimport com.example.wooauto.domain.printer.PrinterManagerimport com.example.wooauto.domain.templates.TemplateTypeimport com.example.wooauto.domain.printer.PrinterStatusimport dagger.hilt.android.AndroidEntryPointimport kotlinx.coroutines.*import kotlinx.coroutines.flow.collectLatestimport kotlinx.coroutines.flow.firstimport kotlinx.coroutines.flow.StateFlowimport kotlinx.coroutines.sync.Muteximport kotlinx.coroutines.sync.withLockimport java.util.*import javax.inject.Injectimport kotlin.collections.HashSetimport androidx.localbroadcastmanager.content.LocalBroadcastManagerimport android.net.ConnectivityManagerimport android.net.Networkimport android.net.NetworkCapabilitiesimport android.net.NetworkRequest@AndroidEntryPointclass BackgroundPollingService : Service() {    companion object {        private const val NOTIFICATION_ID = 1001        private const val CHANNEL_ID = "woo_auto_polling_channel"        private const val TAG = "BackgroundPollingService"                // å¹¿æ’­Actionå¸¸é‡        const val ACTION_NEW_ORDERS_RECEIVED = "com.example.wooauto.NEW_ORDERS_RECEIVED"        const val ACTION_ORDERS_UPDATED = "com.example.wooauto.ORDERS_UPDATED"        const val EXTRA_ORDER_COUNT = "order_count"        const val EXTRA_RESTART_POLLING = "com.example.wooauto.RESTART_POLLING"                // è½®è¯¢é—´éš”å¸¸é‡        private const val DEFAULT_POLLING_INTERVAL = 30 // é»˜è®¤è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰        private const val INITIAL_POLLING_INTERVAL = 5 // åˆå§‹è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰        private const val MIN_POLLING_INTERVAL = 5 // æœ€å°è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰                // æ¸…ç†é—´éš”        private const val CLEANUP_INTERVAL = 10 * 60 * 1000L // 10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡        private const val MAX_PROCESSED_IDS = 500 // æœ€å¤§ä¿ç•™è®¢å•IDæ•°é‡    }    @Inject    lateinit var orderRepository: DomainOrderRepository    @Inject    lateinit var wooCommerceConfig: WooCommerceConfig    @Inject    lateinit var printerManager: PrinterManager    @Inject    lateinit var settingsRepository: DomainSettingRepository    // ä½¿ç”¨IOè°ƒåº¦å™¨åˆ›å»ºåç¨‹ä½œç”¨åŸŸï¼Œå‡å°‘ä¸»çº¿ç¨‹è´Ÿæ‹…    private val serviceScope = CoroutineScope(Dispatchers.IO + SupervisorJob())    private var pollingJob: Job? = null    private var intervalMonitorJob: Job? = null // ç‹¬ç«‹çš„é—´éš”ç›‘å¬ä»»åŠ¡    private var latestPolledDate: Date? = null        // ä½¿ç”¨LRUæ–¹å¼ç®¡ç†å¤„ç†è¿‡çš„è®¢å•IDï¼Œå‡å°‘å†…å­˜å ç”¨    private val processedOrderIds = LinkedHashSet<Long>(MAX_PROCESSED_IDS)        // è½®è¯¢æ§åˆ¶å‚æ•°    private var currentPollingInterval = DEFAULT_POLLING_INTERVAL    private var isAppInForeground = false // è¿½è¸ªåº”ç”¨æ˜¯å¦åœ¨å‰å°    private var initialPollingComplete = false // æ ‡è®°åˆå§‹å¿«é€Ÿè½®è¯¢æ˜¯å¦å®Œæˆ        // å¹¶å‘æ§åˆ¶    private val restartMutex = Mutex() // é˜²æ­¢é‡å¤é‡å¯è½®è¯¢    private var isPollingActive = false // è½®è¯¢çŠ¶æ€æ ‡è®°        // å®šä¹‰ä¸€ä¸ªåœ¨å‰å°æ—¶ä½¿ç”¨è¾ƒçŸ­è½®è¯¢é—´éš”çš„å€æ•°å› å­    private val FOREGROUND_INTERVAL_FACTOR = 0.5f // å‰å°æ—¶è½®è¯¢é—´éš”æ˜¯åå°çš„ä¸€åŠ    // æ·»åŠ ç½‘ç»œçŠ¶æ€ç›‘å¬ç›¸å…³ç»„ä»¶    private var connectivityManager: ConnectivityManager? = null    private var networkCallback: ConnectivityManager.NetworkCallback? = null    private var isNetworkAvailable = true    override fun onBind(intent: Intent?): IBinder? = null    override fun onCreate() {        super.onCreate()        Log.d(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘åå°è½®è¯¢æœåŠ¡å¼€å§‹åˆå§‹åŒ–")                // åˆ›å»ºé€šçŸ¥æ¸ é“å¹¶å¯åŠ¨å‰å°æœåŠ¡        createNotificationChannel()        startForeground()                // åˆå§‹åŒ–ç½‘ç»œç›‘å¬å™¨        initNetworkListener()                // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿åº”ç”¨ç»„ä»¶å®Œå…¨åŠ è½½        serviceScope.launch {            try {                // ç­‰å¾…åº”ç”¨å®ŒæˆåŸºç¡€åˆå§‹åŒ–                delay(2000) // ç»™åº”ç”¨2ç§’æ—¶é—´å®ŒæˆåŸºç¡€åˆå§‹åŒ–                                Log.d(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘å¼€å§‹è¯»å–è½®è¯¢é…ç½®")                                // è¯»å–ä¿å­˜çš„è½®è¯¢é—´éš”è®¾ç½®                currentPollingInterval = withTimeoutOrNull(5000) {                    wooCommerceConfig.pollingInterval.first()                } ?: DEFAULT_POLLING_INTERVAL                                if (currentPollingInterval < MIN_POLLING_INTERVAL) {                    currentPollingInterval = DEFAULT_POLLING_INTERVAL                }                                Log.d(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘è½®è¯¢é—´éš”é…ç½®å®Œæˆ: ${currentPollingInterval}ç§’")                                // æ³¨å†Œå‰å°çŠ¶æ€ç›‘å¬å™¨                registerForegroundStateReceiver()                                Log.d(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘åå°æœåŠ¡åˆå§‹åŒ–å®Œæˆ")            } catch (e: Exception) {                Log.e(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘åˆå§‹åŒ–å¤±è´¥: ${e.message}", e)                currentPollingInterval = DEFAULT_POLLING_INTERVAL                                // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿè¦æ³¨å†Œç›‘å¬å™¨                try {                    registerForegroundStateReceiver()                } catch (e2: Exception) {                    Log.e(TAG, "ã€æœåŠ¡åˆå§‹åŒ–ã€‘æ³¨å†Œç›‘å¬å™¨å¤±è´¥: ${e2.message}")                }            }        }                Log.d(TAG, "æœåŠ¡åˆ›å»ºå®Œæˆ")    }        /**     * æ³¨å†Œå‰å°çŠ¶æ€ç›‘å¬å™¨     * æ ¹æ®åº”ç”¨æ˜¯å¦åœ¨å‰å°è°ƒæ•´è½®è¯¢é—´éš”     */    private fun registerForegroundStateReceiver() {        try {            val filter = IntentFilter().apply {                addAction("android.intent.action.SCREEN_ON")                addAction("android.intent.action.SCREEN_OFF")                addAction("android.intent.action.USER_PRESENT")            }                        ContextCompat.registerReceiver(                this,                object : android.content.BroadcastReceiver() {                    override fun onReceive(context: Context?, intent: Intent?) {                        when (intent?.action) {                            "android.intent.action.SCREEN_ON" -> {                                // å±å¹•ç‚¹äº®ï¼Œå¯èƒ½åœ¨å‰å°                                Log.d(TAG, "å±å¹•ç‚¹äº®ï¼Œè®¾ç½®å‰å°çŠ¶æ€ä¸ºtrue")                                isAppInForeground = true                                adjustPollingInterval()                            }                            "android.intent.action.SCREEN_OFF" -> {                                // å±å¹•å…³é—­ï¼Œä¸€å®šåœ¨åå°                                Log.d(TAG, "å±å¹•å…³é—­ï¼Œè®¾ç½®å‰å°çŠ¶æ€ä¸ºfalseï¼Œè½®è¯¢å°†ç»§ç»­è¿è¡Œ")                                isAppInForeground = false                                adjustPollingInterval()                            }                            "android.intent.action.USER_PRESENT" -> {                                // ç”¨æˆ·è§£é”å±å¹•ï¼Œç¡®å®šåœ¨å‰å°                                Log.d(TAG, "ç”¨æˆ·è§£é”å±å¹•ï¼Œç¡®è®¤å‰å°çŠ¶æ€ä¸ºtrue")                                isAppInForeground = true                                adjustPollingInterval()                            }                        }                    }                },                filter,                ContextCompat.RECEIVER_NOT_EXPORTED            )                        Log.d(TAG, "å·²æ³¨å†Œå‰å°çŠ¶æ€ç›‘å¬å™¨")        } catch (e: Exception) {            Log.e(TAG, "æ³¨å†Œå‰å°çŠ¶æ€ç›‘å¬å™¨å¤±è´¥: ${e.message}", e)        }    }        /**     * æ ¹æ®åº”ç”¨æ˜¯å¦åœ¨å‰å°è°ƒæ•´è½®è¯¢é—´éš”     */    private fun adjustPollingInterval() {        serviceScope.launch {            try {                // å®‰å…¨åœ°è·å–åŸºç¡€è½®è¯¢é—´éš”                val baseInterval = withTimeoutOrNull(3000) {                    wooCommerceConfig.pollingInterval.first()                } ?: DEFAULT_POLLING_INTERVAL                                val newInterval = if (isAppInForeground) {                    // å‰å°ä½¿ç”¨è¾ƒçŸ­çš„é—´éš”                    (baseInterval * FOREGROUND_INTERVAL_FACTOR).toInt().coerceAtLeast(MIN_POLLING_INTERVAL)                } else {                    // åå°ä½¿ç”¨æ­£å¸¸é—´éš”                    baseInterval                }                                if (newInterval != currentPollingInterval) {                    Log.d(TAG, "è°ƒæ•´è½®è¯¢é—´éš”: ${currentPollingInterval}ç§’ -> ${newInterval}ç§’ (å‰å°çŠ¶æ€: $isAppInForeground)")                    currentPollingInterval = newInterval                                        // ä¸å†é‡å¯è½®è¯¢ä»»åŠ¡ï¼Œåªæ›´æ–°é—´éš”å€¼                    // é¿å…åœ¨å±å¹•é”å®šæ—¶ä¸­æ–­è½®è¯¢ä»»åŠ¡                    Log.d(TAG, "è½®è¯¢é—´éš”å·²æ›´æ–°ï¼Œä¸‹æ¬¡è½®è¯¢å‘¨æœŸå°†ä½¿ç”¨æ–°é—´éš”")                }            } catch (e: Exception) {                Log.e(TAG, "è°ƒæ•´è½®è¯¢é—´éš”å¤±è´¥: ${e.message}", e)            }        }    }    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {        // æ£€æŸ¥æ˜¯å¦æ˜¯é‡å¯è½®è¯¢çš„è¯·æ±‚        val shouldRestartPolling = intent?.getBooleanExtra(EXTRA_RESTART_POLLING, false) ?: false                if (shouldRestartPolling) {            Log.d(TAG, "æ”¶åˆ°é‡å¯è½®è¯¢è¯·æ±‚")            restartPolling()        } else {            startPolling()        }                // å¯åŠ¨å®šæœŸæ¸…ç†ä»»åŠ¡        startPeriodicCleanupTask()                return START_STICKY    }    override fun onDestroy() {        Log.d(TAG, "ã€æœåŠ¡é”€æ¯ã€‘å¼€å§‹æ¸…ç†èµ„æº")                // æ ‡è®°è½®è¯¢ä¸ºéæ´»åŠ¨çŠ¶æ€        isPollingActive = false                // å–æ¶ˆæ‰€æœ‰åç¨‹ä»»åŠ¡        pollingJob?.cancel()        intervalMonitorJob?.cancel()                // å–æ¶ˆæ•´ä¸ªæœåŠ¡åç¨‹ä½œç”¨åŸŸ        serviceScope.cancel()                // å–æ¶ˆç½‘ç»œç›‘å¬å™¨æ³¨å†Œ        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {            networkCallback?.let { callback ->                connectivityManager?.unregisterNetworkCallback(callback)                Log.d(TAG, "ç½‘ç»œç›‘å¬å™¨å·²æ³¨é”€")            }        }                Log.d(TAG, "ã€æœåŠ¡é”€æ¯ã€‘èµ„æºæ¸…ç†å®Œæˆ")        super.onDestroy()    }    private fun createNotificationChannel() {        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {            val channel = NotificationChannel(                CHANNEL_ID,                getString(R.string.app_name),                NotificationManager.IMPORTANCE_LOW // é™ä½é€šçŸ¥é‡è¦æ€§ä»¥å‡å°‘ç”¨æˆ·å¹²æ‰°            ).apply {                description = "WooAutoè®¢å•åŒæ­¥æœåŠ¡"            }            val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager            notificationManager.createNotificationChannel(channel)        }    }    private fun startForeground() {        val notification = createNotification(getString(R.string.app_name), "æ­£åœ¨åŒæ­¥è®¢å•æ•°æ®...")                try {            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.Q) {                try {                    startForeground(NOTIFICATION_ID, notification, ServiceInfo.FOREGROUND_SERVICE_TYPE_DATA_SYNC)                    Log.d(TAG, "å‰å°æœåŠ¡å¯åŠ¨æˆåŠŸ (å¸¦ç±»å‹)")                } catch (e: Exception) {                    // å¦‚æœå¸¦ç±»å‹å¯åŠ¨å¤±è´¥ï¼Œå°è¯•ä¸å¸¦ç±»å‹å¯åŠ¨                    Log.w(TAG, "å¸¦ç±»å‹å¯åŠ¨å‰å°æœåŠ¡å¤±è´¥ï¼Œå°è¯•ä¸å¸¦ç±»å‹å¯åŠ¨: ${e.message}")                    startForeground(NOTIFICATION_ID, notification)                    Log.d(TAG, "å‰å°æœåŠ¡å¯åŠ¨æˆåŠŸ (ä¸å¸¦ç±»å‹)")                }            } else {                startForeground(NOTIFICATION_ID, notification)                Log.d(TAG, "å‰å°æœåŠ¡å¯åŠ¨æˆåŠŸ (Android 9åŠä»¥ä¸‹)")            }        } catch (e: Exception) {            Log.e(TAG, "å‰å°æœåŠ¡å¯åŠ¨å¤±è´¥: ${e.message}", e)        }    }    private fun createNotification(title: String, content: String): Notification {        val pendingIntent = PendingIntent.getActivity(            this,            0,            Intent(this, MainActivity::class.java),            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {                PendingIntent.FLAG_IMMUTABLE            } else {                0            }        )        return NotificationCompat.Builder(this, CHANNEL_ID)            .setContentTitle(title)            .setContentText(content)            .setSmallIcon(R.drawable.ic_launcher_foreground)            .setContentIntent(pendingIntent)            .setPriority(NotificationCompat.PRIORITY_LOW) // é™ä½é€šçŸ¥ä¼˜å…ˆçº§            .build()    }    /**     * é‡å¯è½®è¯¢ä»»åŠ¡     * ç”¨äºé…ç½®æ›´æ”¹ååˆ·æ–°     */    private fun restartPolling() {        serviceScope.launch {            restartMutex.withLock {                Log.d(TAG, "é‡å¯è½®è¯¢ä»»åŠ¡ (å·²åŠ é”)")                                // æ ‡è®°è½®è¯¢ä¸ºéæ´»åŠ¨çŠ¶æ€ï¼Œåœæ­¢å½“å‰è½®è¯¢å¾ªç¯                isPollingActive = false                                // ç­‰å¾…å½“å‰è½®è¯¢å¾ªç¯è‡ªç„¶ç»“æŸ                try {                    pollingJob?.join()                } catch (e: Exception) {                    Log.d(TAG, "ç­‰å¾…è½®è¯¢ä»»åŠ¡ç»“æŸ: ${e.message}")                }                pollingJob = null                                // ç­‰å¾…é—´éš”ç›‘å¬ä»»åŠ¡ç»“æŸ                try {                    intervalMonitorJob?.join()                } catch (e: Exception) {                    Log.d(TAG, "ç­‰å¾…é—´éš”ç›‘å¬ä»»åŠ¡ç»“æŸ: ${e.message}")                }                intervalMonitorJob = null                                // çŸ­æš‚å»¶è¿Ÿç¡®ä¿èµ„æºé‡Šæ”¾                delay(100)                                // å¯åŠ¨æ–°çš„è½®è¯¢ä»»åŠ¡                startPolling()            }        }    }    private fun startPolling() {        if (isPollingActive) {            Log.w(TAG, "è½®è¯¢å·²åœ¨è¿è¡Œä¸­ï¼Œè·³è¿‡é‡å¤å¯åŠ¨")            return        }                isPollingActive = true        Log.d(TAG, "å¼€å§‹å¯åŠ¨è½®è¯¢ä»»åŠ¡")                // å¯åŠ¨ç‹¬ç«‹çš„é—´éš”ç›‘å¬ä»»åŠ¡ï¼ˆé¿å…é‡å¤åˆ›å»ºï¼‰        startIntervalMonitor()                pollingJob = serviceScope.launch {            // åº”ç”¨å¯åŠ¨åå…ˆä½¿ç”¨çŸ­é—´éš”è¿›è¡Œåˆå§‹è½®è¯¢            var useInitialInterval = !initialPollingComplete                        if (useInitialInterval) {                Log.d(TAG, "ä½¿ç”¨åˆå§‹å¿«é€Ÿè½®è¯¢é—´éš”: ${INITIAL_POLLING_INTERVAL}ç§’")            }                        // é¦–å…ˆè·å–ä¸€æ¬¡å½“å‰è½®è¯¢é—´éš”            try {                if (!useInitialInterval) {                    currentPollingInterval = withTimeoutOrNull(3000) {                        wooCommerceConfig.pollingInterval.first()                    } ?: DEFAULT_POLLING_INTERVAL                    Log.d(TAG, "åˆå§‹åŒ–è½®è¯¢é—´éš”: ${currentPollingInterval}ç§’")                }            } catch (e: Exception) {                Log.e(TAG, "è·å–åˆå§‹è½®è¯¢é—´éš”å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ${DEFAULT_POLLING_INTERVAL}ç§’", e)                currentPollingInterval = DEFAULT_POLLING_INTERVAL            }                        Log.d(TAG, "ğŸ”„ è½®è¯¢ä¸»å¾ªç¯å¼€å§‹ - isActive: $isActive, isPollingActive: $isPollingActive")                        try {                // ä¸»è½®è¯¢å¾ªç¯                while (isActive && isPollingActive) {                    try {                        // åŠ¨æ€è·å–å½“å‰æœ‰æ•ˆè½®è¯¢é—´éš”                        val effectiveInterval = if (useInitialInterval) {                            INITIAL_POLLING_INTERVAL                        } else {                            // æ ¹æ®å‰å°çŠ¶æ€å®æ—¶è®¡ç®—é—´éš”                            val baseInterval = currentPollingInterval                            if (isAppInForeground) {                                (baseInterval * FOREGROUND_INTERVAL_FACTOR).toInt().coerceAtLeast(MIN_POLLING_INTERVAL)                            } else {                                baseInterval                            }                        }                                                // æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§                        val isValid = checkConfigurationValid()                        Log.d(TAG, "ğŸ” é…ç½®æ£€æŸ¥ç»“æœ: $isValid")                                                if (isValid) {                            Log.d(TAG, "âœ… å¼€å§‹æ‰§è¡Œè½®è¯¢å‘¨æœŸï¼Œé—´éš”: ${effectiveInterval}ç§’ (å‰å°çŠ¶æ€: $isAppInForeground)")                                                        // è®°å½•è½®è¯¢å¼€å§‹æ—¶é—´                            val pollStartTime = System.currentTimeMillis()                                                        // è‡ªé€‚åº”æ‰“å°æœºæ£€æŸ¥ - åªåœ¨åº”ç”¨å¯åŠ¨å’Œæœ‰å¿…è¦æ—¶æ£€æŸ¥                            if (!initialPollingComplete || (pollStartTime - (latestPolledDate?.time ?: 0)) > 5 * 60 * 1000) { // 5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡                                checkPrinterConnection()                            }                                                        // æ‰§è¡Œè½®è¯¢æ“ä½œ                            pollOrders()                                                        // å¦‚æœè¿™æ˜¯åˆå§‹è½®è¯¢ï¼Œæ ‡è®°å®Œæˆ                            if (useInitialInterval) {                                useInitialInterval = false                                initialPollingComplete = true                                Log.d(TAG, "åˆå§‹å¿«é€Ÿè½®è¯¢å®Œæˆï¼Œåˆ‡æ¢åˆ°æ­£å¸¸è½®è¯¢é—´éš”: ${currentPollingInterval}ç§’")                            }                                                        // è®¡ç®—è½®è¯¢æ‰§è¡Œæ—¶é—´                            val pollExecutionTime = System.currentTimeMillis() - pollStartTime                            Log.d(TAG, "è½®è¯¢æ‰§è¡Œè€—æ—¶: ${pollExecutionTime}ms")                                                        // è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´ï¼Œç¡®ä¿æŒ‰ç…§ç”¨æˆ·è®¾ç½®çš„é—´éš”ç²¾ç¡®è½®è¯¢                            val waitTime = (effectiveInterval * 1000L) - pollExecutionTime                            if (waitTime > 0) {                                Log.d(TAG, "ç­‰å¾…ä¸‹æ¬¡è½®è¯¢: ${waitTime}ms")                                delay(waitTime)                            } else {                                Log.w(TAG, "è½®è¯¢æ‰§è¡Œæ—¶é—´è¶…è¿‡é—´éš”è®¾ç½®ï¼Œæ— éœ€ç­‰å¾…ç«‹å³å¼€å§‹ä¸‹æ¬¡è½®è¯¢")                                delay(100) // çŸ­æš‚ç­‰å¾…ä»¥é¿å…CPUå ç”¨è¿‡é«˜                            }                        } else {                            Log.w(TAG, "âŒ é…ç½®æœªå®Œæˆï¼Œè·³è¿‡è½®è¯¢ï¼Œç­‰å¾…${effectiveInterval}ç§’åé‡è¯•")                            delay(effectiveInterval * 1000L)                        }                    } catch (e: Exception) {                        Log.e(TAG, "ğŸ’¥ è½®è¯¢å‘¨æœŸæ‰§è¡Œå‡ºé”™: ${e.message}", e)                        // å¦‚æœæ˜¯å–æ¶ˆå¼‚å¸¸ï¼Œç›´æ¥é€€å‡ºå¾ªç¯                        if (e is kotlinx.coroutines.CancellationException) {                            Log.d(TAG, "ğŸš« è½®è¯¢ä»»åŠ¡è¢«å–æ¶ˆï¼Œæ­£å¸¸é€€å‡º")                            break                        }                        // å…¶ä»–å¼‚å¸¸ç»§ç»­è½®è¯¢ï¼Œä½†ç­‰å¾…æŒ‡å®šé—´éš”                        Log.w(TAG, "âš ï¸ å¼‚å¸¸åç»§ç»­è½®è¯¢ï¼Œç­‰å¾…${currentPollingInterval}ç§’")                        delay(currentPollingInterval * 1000L)                    }                }                                Log.w(TAG, "â¹ï¸ è½®è¯¢ä¸»å¾ªç¯ç»“æŸ - isActive: $isActive, isPollingActive: $isPollingActive")            } finally {                isPollingActive = false                Log.d(TAG, "ğŸ”´ è½®è¯¢ä»»åŠ¡ç»“æŸ")            }        }    }        /**     * å¯åŠ¨ç‹¬ç«‹çš„é—´éš”ç›‘å¬ä»»åŠ¡     */    private fun startIntervalMonitor() {        if (intervalMonitorJob?.isActive == true) {            Log.d(TAG, "é—´éš”ç›‘å¬ä»»åŠ¡å·²åœ¨è¿è¡Œï¼Œè·³è¿‡é‡å¤å¯åŠ¨")            return        }                intervalMonitorJob = serviceScope.launch {            try {                wooCommerceConfig.pollingInterval.collect { newInterval ->                    // ç›´æ¥æ›´æ–°é—´éš”å€¼ï¼Œä¸é‡å¯è½®è¯¢ä»»åŠ¡                    if (newInterval != currentPollingInterval && initialPollingComplete) {                        Log.d(TAG, "æ£€æµ‹åˆ°è½®è¯¢é—´éš”å˜æ›´: ${currentPollingInterval}ç§’ -> ${newInterval}ç§’ï¼Œä¸‹æ¬¡è½®è¯¢å‘¨æœŸç”Ÿæ•ˆ")                        currentPollingInterval = newInterval                    } else if (newInterval != currentPollingInterval) {                        // å¦‚æœè¿˜æœªå®Œæˆåˆå§‹è½®è¯¢ï¼Œåªæ›´æ–°é—´éš”å€¼                        Log.d(TAG, "æ›´æ–°è½®è¯¢é—´éš”: ${currentPollingInterval}ç§’ -> ${newInterval}ç§’")                        currentPollingInterval = newInterval                    }                }            } catch (e: Exception) {                Log.e(TAG, "é—´éš”ç›‘å¬ä»»åŠ¡å¼‚å¸¸: ${e.message}", e)            }        }    }        /**     * æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰æ•ˆ     * @return é…ç½®æ˜¯å¦æœ‰æ•ˆ     */    private suspend fun checkConfigurationValid(): Boolean {        return try {            Log.d(TAG, "ğŸ” å¼€å§‹æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§...")
            
            val siteUrl = wooCommerceConfig.siteUrl.first()
            val consumerKey = wooCommerceConfig.consumerKey.first()
            val consumerSecret = wooCommerceConfig.consumerSecret.first()
            
            val siteUrlValid = siteUrl.isNotBlank()
            val keyValid = consumerKey.isNotBlank()
            val secretValid = consumerSecret.isNotBlank()
            
            Log.d(TAG, "ğŸ“‹ é…ç½®é¡¹æ£€æŸ¥ç»“æœ:")
            Log.d(TAG, "  - siteUrl: ${if (siteUrlValid) "âœ… æœ‰æ•ˆ" else "âŒ æ— æ•ˆ/ä¸ºç©º"} (${siteUrl.take(30)}...)")
            Log.d(TAG, "  - consumerKey: ${if (keyValid) "âœ… æœ‰æ•ˆ" else "âŒ æ— æ•ˆ/ä¸ºç©º"} (${consumerKey.take(10)}...)")
            Log.d(TAG, "  - consumerSecret: ${if (secretValid) "âœ… æœ‰æ•ˆ" else "âŒ æ— æ•ˆ/ä¸ºç©º"} (${consumerSecret.take(10)}...)")
            
            val isValid = siteUrlValid && keyValid && secretValid
            
            if (!isValid) {
                Log.w(TAG, "âš ï¸ WooCommerceé…ç½®æ— æ•ˆ: siteUrl=$siteUrlValid, key=$keyValid, secret=$secretValid")
            } else {
                Log.d(TAG, "âœ… WooCommerceé…ç½®æ£€æŸ¥é€šè¿‡")
            }
            
            isValid
        } catch (e: Exception) {
            Log.e(TAG, "ğŸ’¥ æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§å‡ºé”™: ${e.message}", e)
            false
        }    }    /**     * æ‰§è¡Œä¸€æ¬¡è½®è¯¢     */    private suspend fun pollOrders() {        try {            // è®°å½•ä¸Šæ¬¡è½®è¯¢æ—¶é—´ï¼Œç”¨äºæ—¥å¿—            val lastPollTime = latestPolledDate                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å¼€å§‹æ‰§è¡Œè½®è¯¢ï¼Œä¸Šæ¬¡è½®è¯¢æ—¶é—´: ${lastPollTime?.toString() ?: "é¦–æ¬¡è½®è¯¢"}")                        // æ‰§è¡Œè½®è¯¢            val result = orderRepository.refreshProcessingOrdersForPolling(lastPollTime)                        // æ›´æ–°æœ€æ–°è½®è¯¢æ—¶é—´ä¸ºå½“å‰æ—¶é—´            latestPolledDate = Date()                        // å¤„ç†ç»“æœ            if (result.isSuccess) {                val orders = result.getOrDefault(emptyList())                                // æœ‰æ–°è®¢å•æ—¶è®°å½•æ—¥å¿—                if (orders.isNotEmpty()) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è½®è¯¢æˆåŠŸï¼Œè·å–äº† ${orders.size} ä¸ªå¤„ç†ä¸­è®¢å•")                                        // è¿‡æ»¤å¹¶å¤„ç†æ–°è®¢å•                    val newOrderCount = processNewOrders(orders)                                        // åªæœ‰çœŸæ­£æœ‰æ–°è®¢å•æ—¶æ‰å‘é€å¹¿æ’­                    if (newOrderCount > 0) {                        // å‘é€å¹¿æ’­é€šçŸ¥ç•Œé¢æ›´æ–°                        sendOrdersUpdatedBroadcast()                                                // å‘é€æ–°è®¢å•å¹¿æ’­                        sendNewOrdersBroadcast(newOrderCount)                                                // é€šçŸ¥UIå±‚åˆ·æ–°æ•°æ®                        sendRefreshOrdersBroadcast()                    } else {                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è™½ç„¶è·å–äº†è®¢å•ï¼Œä½†éƒ½æ˜¯å·²å¤„ç†è¿‡çš„ï¼Œä¸å‘é€å¹¿æ’­")                    }                } else {                    // å‡å°‘æ— æ–°è®¢å•æ—¶çš„æ—¥å¿—è¾“å‡ºé¢‘ç‡                    val minutes = System.currentTimeMillis() / 60000                    if (!initialPollingComplete || (minutes % 10L == 0L)) { // æ¯10åˆ†é’Ÿè®°å½•ä¸€æ¬¡ï¼Œä¿®æ”¹ä¸ºLongç±»å‹æ¯”è¾ƒ                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è½®è¯¢æˆåŠŸï¼Œä½†æ²¡æœ‰æ–°çš„å¤„ç†ä¸­è®¢å•")                    }                }            } else {                // å¤„ç†é”™è¯¯                val error = result.exceptionOrNull()                Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è½®è¯¢è®¢å•å¤±è´¥: ${error?.message}", error)            }        } catch (e: Exception) {            Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è½®è¯¢è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)        }    }    /**     * æ£€æŸ¥æ‰“å°æœºè¿æ¥çŠ¶æ€å¹¶å°è¯•é‡æ–°è¿æ¥     * å‡å°‘ä¸å¿ƒè·³æœºåˆ¶çš„å†²çªï¼Œé™ä½æ£€æŸ¥é¢‘ç‡     */    private suspend fun checkPrinterConnection() {        try {            // è·å–é»˜è®¤æ‰“å°æœºé…ç½®            val printerConfig = settingsRepository.getDefaultPrinterConfig()            if (printerConfig != null) {                // æ£€æŸ¥æ‰“å°æœºè¿æ¥çŠ¶æ€                val status = printerManager.getPrinterStatus(printerConfig)                                // åªåœ¨çŠ¶æ€ä¸ºERRORæ—¶è¿›è¡Œé‡è¿ï¼Œè®©å¿ƒè·³æœºåˆ¶å¤„ç†DISCONNECTEDçŠ¶æ€                if (status == PrinterStatus.ERROR) {                    Log.d(TAG, "æ‰“å°æœºçŠ¶æ€é”™è¯¯ï¼Œå°è¯•é‡æ–°è¿æ¥...")                                        // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´å†è¿æ¥ï¼Œé˜²æ­¢ä¸å¿ƒè·³æœºåˆ¶å†²çª                    delay(1000)                                        // ä½¿ç”¨è¶…æ—¶æœºåˆ¶é¿å…è¿æ¥æŒ‚èµ·                    val connected = withTimeoutOrNull(15000) { // ä¸è“ç‰™ç®¡ç†å™¨ä¿æŒä¸€è‡´                        printerManager.connect(printerConfig)                    } ?: false                                        if (connected) {                        Log.d(TAG, "åå°æœåŠ¡æˆåŠŸé‡æ–°è¿æ¥æ‰“å°æœº")                    } else {                        Log.e(TAG, "åå°æœåŠ¡æ— æ³•é‡æ–°è¿æ¥æ‰“å°æœº")                    }                } else if (status == PrinterStatus.CONNECTED) {                    // é™ä½æµ‹è¯•é¢‘ç‡ï¼Œé¿å…ä¸å¿ƒè·³å†²çª                    val minutes = System.currentTimeMillis() / 60000                    if (minutes % 10L == 0L) { // æ”¹ä¸ºæ¯10åˆ†é’Ÿæµ‹è¯•ä¸€æ¬¡                        Log.d(TAG, "å®šæœŸæ£€æŸ¥ï¼šæ‰“å°æœºè¿æ¥çŠ¶æ€æµ‹è¯•")                        try {                            val testResult = printerManager.testConnection(printerConfig)                            if (!testResult) {                                Log.w(TAG, "å®šæœŸæ£€æŸ¥ï¼šæ‰“å°æœºæµ‹è¯•å¤±è´¥ï¼Œæ ‡è®°ä¸ºé”™è¯¯çŠ¶æ€")                                // ä¸ç›´æ¥é‡è¿ï¼Œè®©å¿ƒè·³æœºåˆ¶å¤„ç†                            }                        } catch (e: Exception) {                            Log.e(TAG, "å®šæœŸæ£€æŸ¥ï¼šæµ‹è¯•è¿æ¥å¼‚å¸¸", e)                        }                    }                }                // DISCONNECTEDçŠ¶æ€ç”±å¿ƒè·³æœºåˆ¶å¤„ç†ï¼Œé¿å…é‡å¤å¤„ç†            } else {                Log.d(TAG, "æ²¡æœ‰é…ç½®é»˜è®¤æ‰“å°æœº")            }        } catch (e: Exception) {            Log.e(TAG, "æ£€æŸ¥æ‰“å°æœºè¿æ¥çŠ¶æ€å¤±è´¥", e)        }    }    private suspend fun processNewOrders(orders: List<Order>): Int {        var newOrderCount = 0                Log.d(TAG, "å¤„ç†æ–°è®¢å•ï¼Œå…± ${orders.size} ä¸ª")                // ç¡®å®šåº”ç”¨å¯åŠ¨åçš„é¦–æ¬¡è½®è¯¢        val isFirstPolling = latestPolledDate == null        Log.d(TAG, "æ˜¯å¦é¦–æ¬¡è½®è¯¢: $isFirstPolling")                // è·å–å½“å‰æ—¶é—´        val currentTime = System.currentTimeMillis()        // è®¡ç®—5åˆ†é’Ÿå‰çš„æ—¶é—´æˆ³ï¼Œç”¨äºè¿‡æ»¤æ—§è®¢å•        val fiveMinutesAgo = currentTime - (5 * 60 * 1000)                for (order in orders) {            // é¦–å…ˆæ£€æŸ¥è®¢å•æ˜¯å¦å·²å¤„ç†ï¼Œé¿å…åœ¨åŒæ­¥å—ä¸­è¿›è¡Œå¤æ‚æ“ä½œ            val isProcessed = synchronized(processedOrderIds) {                processedOrderIds.contains(order.id)            }                        // æ£€æŸ¥æ˜¯å¦å¤„ç†è¿‡æ­¤è®¢å•            val isNewOrder = !isProcessed                        // é¦–æ¬¡è½®è¯¢æ—¶ï¼Œåªå¤„ç†5åˆ†é’Ÿå†…çš„æ–°è®¢å•ï¼Œé¿å…å¤„ç†å†å²è®¢å•            val isRecentOrder = if (isFirstPolling) {                order.dateCreated.time > fiveMinutesAgo            } else {                true // éé¦–æ¬¡è½®è¯¢æ—¶ï¼Œæ‰€æœ‰æœªå¤„ç†è®¢å•éƒ½è§†ä¸ºæ–°è®¢å•            }                        // è®°å½•è®¢å•æ—¶é—´ä¸å½“å‰æ—¶é—´çš„å·®è·            val timeDiff = (currentTime - order.dateCreated.time) / 1000 // ç§’            Log.d(TAG, "è®¢å• #${order.number} åˆ›å»ºäº ${timeDiff}ç§’å‰, é¦–æ¬¡è½®è¯¢: $isFirstPolling, æ˜¯å¦æ–°è®¢å•: $isNewOrder, æ˜¯å¦æœ€è¿‘è®¢å•: $isRecentOrder")                        if (isNewOrder && isRecentOrder) {                Log.d(TAG, "ã€æ‰“å°çŠ¶æ€ä¿æŠ¤ã€‘å¤„ç†æ–°è®¢å•: #${order.number}, ID: ${order.id}, çŠ¶æ€: ${order.status}, APIä¸­æ‰“å°çŠ¶æ€: ${order.isPrinted}")                                // è·å–æ•°æ®åº“ä¸­çš„æ‰“å°çŠ¶æ€ - æ•°æ®åº“æ˜¯æ‰“å°çŠ¶æ€çš„çœŸå®æ¥æº                val latestOrder = orderRepository.getOrderById(order.id)                val isPrintedInDb = latestOrder?.isPrinted ?: false                                Log.d(TAG, "ã€æ‰“å°çŠ¶æ€ä¿æŠ¤ã€‘è®¢å• #${order.number} çš„æ•°æ®åº“æ‰“å°çŠ¶æ€: $isPrintedInDb")                                // åˆ›å»ºæœ€ç»ˆå¤„ç†çš„è®¢å•å¯¹è±¡ï¼Œä»¥æ•°æ®åº“æ‰“å°çŠ¶æ€ä¸ºå‡†                val finalOrder = if (latestOrder != null) {                    // ä½¿ç”¨æ•°æ®åº“è®¢å•ï¼Œä½†ä¿ç•™APIè®¢å•çš„å…¶ä»–å­—æ®µ                    order.copy(isPrinted = latestOrder.isPrinted)                } else {                    // å¦‚æœæ•°æ®åº“ä¸­æ²¡æœ‰æ­¤è®¢å•ï¼Œä½¿ç”¨APIè®¢å•çŠ¶æ€                    order                }                                Log.d(TAG, "ã€æ‰“å°çŠ¶æ€ä¿æŠ¤ã€‘æœ€ç»ˆå¤„ç†çš„è®¢å• #${finalOrder.number} æ‰“å°çŠ¶æ€: ${finalOrder.isPrinted}")                                // ä¸å†æ ¹æ®APIå’Œæ•°æ®åº“çš„ä¸ä¸€è‡´è¿›è¡Œæ›´æ–°ï¼Œè€Œæ˜¯å§‹ç»ˆä»¥æ•°æ®åº“ä¸ºä¸»                // è¿™ç¡®ä¿äº†æ‰‹åŠ¨æ ‡è®°çš„æ‰“å°çŠ¶æ€ä¸ä¼šè¢«APIè¦†ç›–                                // å‘é€é€šçŸ¥                sendNewOrderNotification(finalOrder)                                // å¯ç”¨è‡ªåŠ¨æ‰“å°åŠŸèƒ½ï¼Œå¹¶æ·»åŠ è¯¦ç»†æ—¥å¿—                Log.d(TAG, "====== å¼€å§‹å¤„ç†è®¢å•è‡ªåŠ¨æ‰“å° ======")                                // ä½¿ç”¨æœ€ç»ˆè®¢å•çš„æ‰“å°çŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰“å°                val shouldPrint = !finalOrder.isPrinted && finalOrder.status == "processing"                Log.d(TAG, "ã€æ‰“å°çŠ¶æ€ä¿æŠ¤ã€‘æ˜¯å¦éœ€è¦æ‰“å°: $shouldPrint (æœ€ç»ˆæ‰“å°çŠ¶æ€=${finalOrder.isPrinted}, status=${finalOrder.status})")                                if (shouldPrint) {                    // è°ƒç”¨printOrderæ–¹æ³•å¤„ç†æ‰“å°                    printOrder(finalOrder)                } else if (finalOrder.isPrinted) {                    Log.d(TAG, "ã€æ‰“å°çŠ¶æ€ä¿æŠ¤ã€‘è®¢å• #${finalOrder.number} å·²æ ‡è®°ä¸ºå·²æ‰“å°ï¼Œè·³è¿‡æ‰“å°")                }                                // å…ˆæ ‡è®°è®¢å•é€šçŸ¥å·²æ˜¾ç¤ºï¼Œç„¶åå†æ·»åŠ åˆ°å·²å¤„ç†é›†åˆ                orderRepository.markOrderNotificationShown(finalOrder.id)                                // æ·»åŠ åˆ°å·²å¤„ç†é›†åˆ                synchronized(processedOrderIds) {                    processedOrderIds.add(finalOrder.id)                                        // ç»´æŠ¤LRUç¼“å­˜å¤§å°                    if (processedOrderIds.size > MAX_PROCESSED_IDS) {                        removeOldestProcessedId()                    }                }                                newOrderCount++            } else {                val skipReason = if (!isNewOrder) "å·²å¤„ç†è¿‡" else "éæœ€è¿‘è®¢å•"                Log.d(TAG, "è®¢å•è·³è¿‡å¤„ç†ï¼ŒåŸå› : $skipReason: #${order.number}")            }        }                return newOrderCount    }        /**     * ç§»é™¤æœ€æ—§çš„å¤„ç†è¿‡çš„è®¢å•ID     * ä½¿ç”¨LinkedHashSetå®ç°LRUç¼“å­˜åŠŸèƒ½     */    private fun removeOldestProcessedId() {        synchronized(processedOrderIds) {            if (processedOrderIds.isNotEmpty()) {                val oldestId = processedOrderIds.iterator().next()                processedOrderIds.remove(oldestId)                Log.d(TAG, "ä»å¤„ç†è®°å½•ä¸­ç§»é™¤æœ€æ—§çš„è®¢å•ID: $oldestId, å½“å‰ç¼“å­˜å¤§å°: ${processedOrderIds.size}")            }        }    }    private fun sendNewOrderNotification(order: Order) {        val notificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager                val notification = NotificationCompat.Builder(this, CHANNEL_ID)            .setContentTitle(getString(R.string.new_order_received))            .setContentText("è®¢å•å·: ${order.number}, é‡‘é¢: ${order.total}")            .setSmallIcon(R.drawable.ic_launcher_foreground)            .setPriority(NotificationCompat.PRIORITY_HIGH)            .setAutoCancel(true)            .build()                notificationManager.notify(order.id.toInt(), notification)                // åœ¨æ­¤å¤„å¯ä»¥å‘é€å¹¿æ’­ï¼Œé€šçŸ¥åº”ç”¨å†…çš„UIç»„ä»¶æ˜¾ç¤ºå¼¹çª—        val intent = Intent("com.example.wooauto.NEW_ORDER_RECEIVED")        intent.putExtra("orderId", order.id)        sendBroadcast(intent)    }    private fun printOrder(order: Order) {        serviceScope.launch {            try {                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å¼€å§‹æ‰§è¡Œè‡ªåŠ¨æ‰“å°è®¢å•: #${order.number}")                                // æ£€æŸ¥è®¢å•æ˜¯å¦å·²æ‰“å°                if (order.isPrinted) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è®¢å•å·²æ‰“å°ï¼Œè·³è¿‡: #${order.number}")                    return@launch                }                                // æ£€æŸ¥è®¢å•çŠ¶æ€æ˜¯å¦ä¸º"å¤„ç†ä¸­"                if (order.status != "processing") {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è®¢å•çŠ¶æ€éå¤„ç†ä¸­ï¼Œä¸è‡ªåŠ¨æ‰“å°: ${order.status}")                    return@launch                }                                // è·å–é»˜è®¤æ‰“å°æœºé…ç½®                val printerConfig = settingsRepository.getDefaultPrinterConfig()                if (printerConfig == null) {                    Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æœªè®¾ç½®é»˜è®¤æ‰“å°æœºï¼Œæ— æ³•æ‰“å°è®¢å•")                    return@launch                }                                // æ£€æŸ¥æ˜¯å¦å¼€å¯è‡ªåŠ¨æ‰“å° - éœ€è¦åŒæ—¶æ£€æŸ¥å…¨å±€è®¾ç½®å’Œæ‰“å°æœºè®¾ç½®                val globalAutoPrintEnabled = settingsRepository.getAutoPrintEnabled()                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ£€æŸ¥å…¨å±€è‡ªåŠ¨æ‰“å°è®¾ç½®: enabled=$globalAutoPrintEnabled")                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ£€æŸ¥æ‰“å°æœºè‡ªåŠ¨æ‰“å°è®¾ç½®: isAutoPrint=${printerConfig.isAutoPrint}")                                if (!globalAutoPrintEnabled) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å…¨å±€è‡ªåŠ¨æ‰“å°åŠŸèƒ½æœªå¼€å¯ï¼Œè·³è¿‡")                    return@launch                }                                if (!printerConfig.isAutoPrint) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°æœºé…ç½®æœªå¼€å¯è‡ªåŠ¨æ‰“å°ï¼Œè·³è¿‡")                    return@launch                }                                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å‡†å¤‡è‡ªåŠ¨æ‰“å°æ–°è®¢å•: #${order.number}, æ‰“å°æœº: ${printerConfig.name}")                                // è·å–ç”¨æˆ·è®¾ç½®çš„é»˜è®¤æ¨¡æ¿ç±»å‹                val defaultTemplateType = settingsRepository.getDefaultTemplateType()                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘ä½¿ç”¨é»˜è®¤æ‰“å°æ¨¡æ¿: $defaultTemplateType")                                // æ£€æŸ¥æ‰“å°æœºæ˜¯å¦å·²è¿æ¥ï¼Œå¦‚æœæœªè¿æ¥åˆ™å…ˆå°è¯•è¿æ¥                val printerStatus = printerManager.getPrinterStatus(printerConfig)                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å½“å‰æ‰“å°æœºçŠ¶æ€: $printerStatus")                                if (printerStatus != PrinterStatus.CONNECTED) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°æœºæœªè¿æ¥ï¼Œå°è¯•è¿æ¥æ‰“å°æœº: ${printerConfig.name}")                                        // ä½¿ç”¨è¶…æ—¶æœºåˆ¶é¿å…è¿æ¥æŒ‚èµ·                    val connected = withTimeoutOrNull(15000) { // ä¸è“ç‰™ç®¡ç†å™¨ä¿æŒä¸€è‡´                        printerManager.connect(printerConfig)                    } ?: false                                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°æœºè¿æ¥ç»“æœ: $connected")                                        if (!connected) {                        Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ— æ³•è¿æ¥æ‰“å°æœºï¼Œæ‰“å°å¤±è´¥: ${printerConfig.name}")                        return@launch                    }                }                                // å†æ¬¡æ£€æŸ¥è®¢å•æ˜¯å¦å·²ç»è¢«æ ‡è®°ä¸ºå·²æ‰“å°ï¼ˆå¯èƒ½åœ¨è½®è¯¢æœŸé—´è¢«æ‰‹åŠ¨æ‰“å°ï¼‰                val updatedOrder = orderRepository.getOrderById(order.id)                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å†æ¬¡æ£€æŸ¥è®¢å•æ‰“å°çŠ¶æ€: ${updatedOrder?.isPrinted}")                                if (updatedOrder?.isPrinted == true) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è®¢å•åœ¨è½®è¯¢é—´éš”å†…å·²è¢«æ ‡è®°ä¸ºå·²æ‰“å°ï¼Œè·³è¿‡æ‰“å°: #${order.number}")                    return@launch                }                                // æ‰“å°è®¢å•                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å¼€å§‹æ‰§è¡Œæ‰“å°è®¢å•: #${order.number}")                                // ä½¿ç”¨è¶…æ—¶æœºåˆ¶é¿å…æ‰“å°æ“ä½œæŒ‚èµ·                val printResult = withTimeoutOrNull(30000) { // 30ç§’è¶…æ—¶                    printerManager.printOrder(order, printerConfig)                } ?: false                                Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°ç»“æœ: ${if (printResult) "æˆåŠŸ" else "å¤±è´¥"}")                                if (printResult) {                    Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°æˆåŠŸï¼Œè®¢å•å°†ç”±æ‰“å°ç®¡ç†å™¨è‡ªåŠ¨æ ‡è®°ä¸ºå·²æ‰“å°: #${order.number}")                                        // éªŒè¯æ ‡è®°æ˜¯å¦æˆåŠŸï¼ˆä»…ç”¨äºæ—¥å¿—éªŒè¯ï¼‰                    val finalOrder = orderRepository.getOrderById(order.id)                    if (finalOrder?.isPrinted == true) {                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘éªŒè¯ï¼šè®¢å• #${order.number} å·²è¢«æ­£ç¡®æ ‡è®°ä¸ºå·²æ‰“å°")                    } else {                        Log.w(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ³¨æ„ï¼šè®¢å• #${order.number} å¯èƒ½è¿˜æœªè¢«æ ‡è®°ä¸ºå·²æ‰“å°ï¼ŒçŠ¶æ€: ${finalOrder?.isPrinted}")                    }                } else {                    Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘æ‰“å°å¤±è´¥ï¼Œè®¢å• #${order.number} ç»´æŒæœªæ‰“å°çŠ¶æ€")                }            } catch (e: Exception) {                Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘è‡ªåŠ¨æ‰“å°è®¢å•æ—¶å‘ç”Ÿå¼‚å¸¸: ${e.message}", e)            }        }    }        /**     * å‘é€è®¢å•æ›´æ–°å¹¿æ’­     * é€šçŸ¥å‰ç«¯ç•Œé¢åˆ·æ–°è®¢å•åˆ—è¡¨ï¼ˆæ— è®ºæ˜¯å¦æœ‰æ–°è®¢å•ï¼‰     */    private fun sendOrdersUpdatedBroadcast() {        Log.d(TAG, "å‘é€è®¢å•æ›´æ–°å¹¿æ’­")        val intent = Intent(ACTION_ORDERS_UPDATED)        sendBroadcast(intent)    }        /**     * å‘é€æ–°è®¢å•å¹¿æ’­     * é€šçŸ¥å‰ç«¯æœ‰æ–°è®¢å•åˆ°è¾¾     */    private fun sendNewOrdersBroadcast(count: Int) {        Log.d(TAG, "å‘é€æ–°è®¢å•å¹¿æ’­ï¼Œè®¢å•æ•°é‡: $count")        val intent = Intent(ACTION_NEW_ORDERS_RECEIVED)        intent.putExtra(EXTRA_ORDER_COUNT, count)        sendBroadcast(intent)    }    /**     * å‘é€åˆ·æ–°è®¢å•çš„å¹¿æ’­     * é€šçŸ¥UIå±‚åˆ·æ–°è®¢å•æ•°æ®     */    private fun sendRefreshOrdersBroadcast() {        try {            val intent = Intent("com.example.wooauto.REFRESH_ORDERS")            LocalBroadcastManager.getInstance(this).sendBroadcast(intent)            Log.d(TAG, "å·²å‘é€åˆ·æ–°è®¢å•å¹¿æ’­")        } catch (e: Exception) {            Log.e(TAG, "å‘é€åˆ·æ–°è®¢å•å¹¿æ’­å¤±è´¥: ${e.message}", e)        }    }    /**     * å¯åŠ¨å®šæœŸæ¸…ç†ä»»åŠ¡     * æ¯10åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡å¤„ç†é˜Ÿåˆ—å’Œç¼“å­˜     */    private fun startPeriodicCleanupTask() {        serviceScope.launch {            while (true) {                try {                    // ç­‰å¾…æ¸…ç†é—´éš”                    delay(CLEANUP_INTERVAL)                                        synchronized(processedOrderIds) {                        // å¦‚æœå¤„ç†é˜Ÿåˆ—è¿‡å¤§ï¼Œæ¸…ç†åˆ°æœ€å¤§é™åˆ¶çš„ä¸€åŠ                        if (processedOrderIds.size > MAX_PROCESSED_IDS) {                            val targetSize = MAX_PROCESSED_IDS / 2                            val sizeBefore = processedOrderIds.size                                                        while (processedOrderIds.size > targetSize) {                                // ç§»é™¤æœ€æ—§çš„å…ƒç´                                 removeOldestProcessedId()                            }                                                        Log.d(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å·²æ¸…ç†è®¢å•å¤„ç†é˜Ÿåˆ—: ${sizeBefore} -> ${processedOrderIds.size}")                        }                    }                                        // é‡Šæ”¾è¿è¡Œæ—¶å†…å­˜                    System.gc()                } catch (e: Exception) {                    Log.e(TAG, "ã€è‡ªåŠ¨æ‰“å°è°ƒè¯•ã€‘å®šæœŸæ¸…ç†ä»»åŠ¡å¼‚å¸¸: ${e.message}", e)                }            }        }    }    // åˆå§‹åŒ–ç½‘ç»œç›‘å¬å™¨    private fun initNetworkListener() {        connectivityManager = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {            networkCallback = object : ConnectivityManager.NetworkCallback() {                override fun onAvailable(network: Network) {                    super.onAvailable(network)                    val wasOffline = !isNetworkAvailable                    isNetworkAvailable = true                                        // åªæœ‰åœ¨ç¡®å®ä»ç¦»çº¿çŠ¶æ€æ¢å¤ä¸”å½“å‰æ­£åœ¨è½®è¯¢æ—¶ï¼Œæ‰è§¦å‘ä¸€æ¬¡é¢å¤–è½®è¯¢                    if (wasOffline && isPollingActive && initialPollingComplete) {                        Log.d(TAG, "ç½‘ç»œä»ç¦»çº¿çŠ¶æ€æ¢å¤ï¼Œè§¦å‘ä¸€æ¬¡æ¢å¤è½®è¯¢")                        serviceScope.launch {                            try {                                // ç­‰å¾…ç½‘ç»œå®Œå…¨ç¨³å®š                                delay(1000)                                // åªæ‰§è¡Œä¸€æ¬¡è½®è¯¢ï¼Œä¸å‘é€é¢å¤–å¹¿æ’­                                val result = orderRepository.refreshProcessingOrdersForPolling(latestPolledDate)                                if (result.isSuccess) {                                    val orders = result.getOrDefault(emptyList())                                    if (orders.isNotEmpty()) {                                        Log.d(TAG, "ç½‘ç»œæ¢å¤è½®è¯¢æˆåŠŸï¼Œè·å–äº† ${orders.size} ä¸ªè®¢å•")                                        // åªå¤„ç†æ–°è®¢å•ï¼Œä¸å‘é€å¤šä½™å¹¿æ’­                                        processNewOrders(orders)                                    }                                }                            } catch (e: Exception) {                                Log.e(TAG, "ç½‘ç»œæ¢å¤åè½®è¯¢å¤±è´¥: ${e.message}")                            }                        }                    } else {                        Log.d(TAG, "ç½‘ç»œè¿æ¥å·²æ¢å¤ (æ— éœ€é¢å¤–è½®è¯¢)")                    }                }                                override fun onLost(network: Network) {                    super.onLost(network)                    isNetworkAvailable = false                    Log.d(TAG, "ç½‘ç»œè¿æ¥å·²æ–­å¼€")                }                                override fun onCapabilitiesChanged(network: Network, networkCapabilities: NetworkCapabilities) {                    super.onCapabilitiesChanged(network, networkCapabilities)                    val hasInternet = networkCapabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET) &&                                     networkCapabilities.hasCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED)                                        if (hasInternet != isNetworkAvailable) {                        val previousState = isNetworkAvailable                        isNetworkAvailable = hasInternet                        Log.d(TAG, "ç½‘ç»œçŠ¶æ€å˜åŒ–: $previousState -> $isNetworkAvailable")                                                // é¿å…é¢‘ç¹çš„ç½‘ç»œè´¨é‡å˜åŒ–è§¦å‘è½®è¯¢                        if (hasInternet && !previousState && isPollingActive && initialPollingComplete) {                            Log.d(TAG, "ç½‘ç»œè´¨é‡æ¢å¤ï¼Œä½†ä¸è§¦å‘é¢å¤–è½®è¯¢ï¼ˆç”±æ­£å¸¸è½®è¯¢å‘¨æœŸå¤„ç†ï¼‰")                        }                    }                }            }                        val networkRequest = NetworkRequest.Builder()                .addCapability(NetworkCapabilities.NET_CAPABILITY_INTERNET)                .addCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED)                .build()                            connectivityManager?.registerNetworkCallback(networkRequest, networkCallback!!)            Log.d(TAG, "ç½‘ç»œç›‘å¬å™¨å·²æ³¨å†Œ")        } else {            Log.d(TAG, "Androidç‰ˆæœ¬ä¸æ”¯æŒç½‘ç»œå›è°ƒï¼Œä½¿ç”¨ä¼ ç»Ÿæ–¹å¼æ£€æŸ¥ç½‘ç»œ")        }    }} 